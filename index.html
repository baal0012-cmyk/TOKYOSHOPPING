<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠå¿…è²·æ¸…å–® App</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Noto Sans è®“ä¸­æ–‡å­—é«”æ›´ç¾è§€ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .scroll-area {
            max-height: calc(100vh - 360px); /* èª¿æ•´ä»¥é©æ‡‰ä¸åŒè¢å¹•å¤§å° */
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">

            <!-- æ¨™é¡Œèˆ‡ä½¿ç”¨è€…è³‡è¨Š -->
            <header class="mb-8 border-b pb-4">
                <h1 class="text-3xl font-extrabold text-blue-600 mb-2">ğŸ‡¯ğŸ‡µ æ—…éŠå¿…è²·æ¸…å–® App</h1>
                <p class="text-gray-500 text-sm">
                    å³æ™‚æ¸…å–®ç®¡ç†èˆ‡æ—¥å¹£æ›ç®—å°å¹£åŠŸèƒ½ã€‚
                </p>
                <div id="user-info" class="text-xs text-gray-400 mt-2">
                    <!-- User ID will be displayed here -->
                </div>
            </header>

            <!-- åŒ¯ç‡è¨­å®šèˆ‡ç¸½è¦½ -->
            <section class="mb-8 p-4 bg-yellow-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-yellow-700 mb-3">åŒ¯ç‡è¨­å®šèˆ‡æ¶ˆè²»ç¸½è¦½</h2>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <!-- åŒ¯ç‡è¼¸å…¥ -->
                    <div class="flex-grow">
                        <label for="exchange-rate" class="block text-sm font-medium text-gray-700">JPY å…Œ TWD åŒ¯ç‡ (1 JPY = ? TWD)</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="number" id="exchange-rate" value="0.22" step="0.001"
                                class="flex-1 block w-full rounded-l-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 p-2 border"
                                placeholder="0.22">
                            <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                TWD
                            </span>
                        </div>
                    </div>
                    
                    <!-- ç¸½èŠ±è²»è¨ˆç®— -->
                    <div class="flex-grow">
                        <p class="text-sm font-medium text-gray-700">å·²è³¼è²·ç¸½èŠ±è²» (TWD)</p>
                        <p id="total-spent" class="text-2xl font-bold text-red-500 mt-1 p-2 rounded-md bg-white border border-red-200">
                            TWD 0
                        </p>
                    </div>
                </div>
            </section>


            <!-- æ–°å¢é …ç›®è¡¨å–® -->
            <section class="mb-8 p-6 bg-blue-50 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">æ–°å¢è³¼ç‰©é …ç›®</h2>
                <form id="add-item-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- é …ç›®åç¨± -->
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-700">åç¨±/å“é …</label>
                            <input type="text" id="item-name" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <!-- æ—¥å¹£åƒ¹æ ¼ -->
                        <div>
                            <label for="item-jpy" class="block text-sm font-medium text-gray-700">åƒ¹æ ¼ (JPY)</label>
                            <input type="number" id="item-jpy" required min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <!-- é è¨ˆè³¼è²·/è¡Œç¨‹æ—¥ -->
                        <div>
                            <label for="item-day" class="block text-sm font-medium text-gray-700">é è¨ˆè¡Œç¨‹æ—¥ (ä¾‹å¦‚: Day 1)</label>
                            <input type="text" id="item-day" placeholder="Day 1" value="Day 1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <!-- æ•¸é‡ -->
                        <div>
                            <label for="item-quantity" class="block text-sm font-medium text-gray-700">æ•¸é‡</label>
                            <input type="number" id="item-quantity" value="1" min="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    
                    <!-- åœ–ç‰‡ç¶²å€ (æ–°å¢) -->
                    <div>
                        <label for="item-image-url" class="block text-sm font-medium text-gray-700">åœ–ç‰‡ç¶²å€ (Image URL) <span class="text-gray-400">(é¸å¡«)</span></label>
                        <input type="url" id="item-image-url" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                            placeholder="https://example.com/product.jpg">
                    </div>

                    <button type="submit"
                        class="w-full md:w-auto px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        ğŸ’¾ åŠ å…¥æ¸…å–®
                    </button>
                </form>
            </section>

            <!-- è³¼ç‰©æ¸…å–® -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">å¿…è²·é …ç›®æ¸…å–®</h2>

                <!-- ç¯©é¸/åˆ†çµ„é¸å–® -->
                <div class="mb-4 flex space-x-4">
                    <button id="filter-all" class="px-3 py-1 text-sm rounded-full bg-blue-500 text-white shadow">å…¨éƒ¨é …ç›®</button>
                    <button id="filter-unbought" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">æœªè³¼è²·</button>
                    <button id="filter-bought" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">å·²è³¼è²·</button>
                </div>
                
                <div id="shopping-list-container" class="space-y-4">
                    <!-- æ¸…å–®å°‡é€é JavaScript æ¸²æŸ“åˆ°é€™è£¡ -->
                    <p id="loading-message" class="text-center text-gray-500">è¼‰å…¥ä¸­...</p>
                    <p id="empty-message" class="text-center text-gray-500 hidden">æ¸…å–®æ˜¯ç©ºçš„ï¼Œå¿«æ–°å¢ä¸€äº›é …ç›®å§ï¼</p>
                </div>
            </section>

            <!-- éŒ¯èª¤è¨Šæ¯/Modal (é alert) -->
            <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <h3 id="message-title" class="text-xl font-bold text-red-600 mb-3">éŒ¯èª¤</h3>
                    <p id="message-content" class="text-gray-700 mb-4">ç™¼ç”Ÿäº†ä¸€å€‹éŒ¯èª¤ã€‚</p>
                    <button id="message-close" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ç¢ºèª</button>
                </div>
            </div>

        </div>
    </div>

    <!-- è¼‰å…¥ Firebase SDK -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Debug Log Level
        setLogLevel('Debug');

        // --- å…¨åŸŸè®Šæ•¸èˆ‡ Firebase åˆå§‹åŒ– ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let shoppingItems = [];
        let currentFilter = 'all';

        // é è¨­åŒ¯ç‡ (1 JPY = X TWD)
        let exchangeRate = 0.22;
        const EXCHANGE_RATE_KEY = 'exchangeRate';

        // UI Elements
        const listContainer = document.getElementById('shopping-list-container');
        const form = document.getElementById('add-item-form');
        const rateInput = document.getElementById('exchange-rate');
        const totalSpentElement = document.getElementById('total-spent');
        const loadingMessage = document.getElementById('loading-message');
        const emptyMessage = document.getElementById('empty-message');

        // Modal Elements
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const messageClose = document.getElementById('message-close');
        
        // Filter Buttons
        const filterButtons = {
            'all': document.getElementById('filter-all'),
            'unbought': document.getElementById('filter-unbought'),
            'bought': document.getElementById('filter-bought'),
        };

        // --- è¼”åŠ©å‡½æ•¸ ---

        /** é¡¯ç¤ºè‡ªè¨‚è¨Šæ¯æ¡† (å–ä»£ alert) */
        function showMessage(title, content, isError = true) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageTitle.className = `text-xl font-bold mb-3 ${isError ? 'text-red-600' : 'text-green-600'}`;
            messageClose.className = `w-full px-4 py-2 text-white rounded-lg ${isError ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}`;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        messageClose.addEventListener('click', () => {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        });

        /** åŒ¯ç‡è¨ˆç®— */
        function calculateTWD(jpyPrice, quantity) {
            return (jpyPrice * quantity * exchangeRate).toFixed(2);
        }

        /** ç²å– Firestore é›†åˆè·¯å¾‘ */
        function getCollectionPath() {
            if (!userId) {
                console.error("User ID is not defined.");
                // For development, use a fallback path
                return `artifacts/${appId}/users/guest-user/must_buy_list`;
            }
            // Use private data path for the user's shopping list
            return `artifacts/${appId}/users/${userId}/must_buy_list`;
        }

        // --- æ•¸æ“šæŒä¹…åŒ– (åŒ¯ç‡) ---

        /** è¼‰å…¥æœ¬åœ°åŒ¯ç‡ */
        function loadExchangeRate() {
            const savedRate = localStorage.getItem(EXCHANGE_RATE_KEY);
            if (savedRate) {
                exchangeRate = parseFloat(savedRate);
                rateInput.value = exchangeRate.toString();
            }
        }

        /** å„²å­˜åŒ¯ç‡ */
        function saveExchangeRate(rate) {
            exchangeRate = parseFloat(rate);
            localStorage.setItem(EXCHANGE_RATE_KEY, exchangeRate.toString());
            // åŒ¯ç‡è®Šå‹•æ™‚ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°åƒ¹æ ¼
            renderList();
            calculateTotalSpent(shoppingItems);
        }

        // ç›£è½åŒ¯ç‡è¼¸å…¥æ¡†è®ŠåŒ–
        rateInput.addEventListener('change', (e) => {
            const newRate = parseFloat(e.target.value);
            if (newRate > 0) {
                saveExchangeRate(newRate);
            } else {
                e.target.value = exchangeRate; // Revert if invalid
                showMessage('éŒ¯èª¤', 'åŒ¯ç‡å¿…é ˆæ˜¯æ­£æ•¸ï¼', true);
            }
        });

        // --- Firebase/Auth è¨­ç½® ---

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // åŸ·è¡Œç™»å…¥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `ä½¿ç”¨è€… ID: ${userId} (æ•¸æ“šå·²å³æ™‚å„²å­˜)`;
                        startDataListener(); // èªè­‰å®Œæˆå¾Œé–‹å§‹ç›£è½è³‡æ–™
                    } else {
                        // åŒ¿åç™»å…¥å¤±æ•—æˆ–ç™»å‡º
                        userId = null;
                        document.getElementById('user-info').textContent = `ç™»å…¥å¤±æ•—æˆ–æœªç™»å…¥ã€‚`;
                        loadingMessage.textContent = 'è«‹æª¢æŸ¥ç™»å…¥ç‹€æ…‹...';
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingMessage.textContent = `Firebase éŒ¯èª¤ï¼š${error.code}`;
                showMessage('ç³»çµ±éŒ¯èª¤', 'Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¨­å®šã€‚', true);
            }
        }

        // --- Firestore æ•¸æ“šæ“ä½œ (CRUD) ---

        /** ç›£è½ Firestore æ•¸æ“šè®ŠåŒ– */
        function startDataListener() {
            if (!db || !userId) return;

            const listCollectionRef = collection(db, getCollectionPath());
            
            // ä½¿ç”¨ onSnapshot å¯¦ç¾å¯¦æ™‚ç›£è½
            onSnapshot(listCollectionRef, (snapshot) => {
                loadingMessage.classList.add('hidden');
                
                // å°‡ Firestore æ–‡ä»¶è½‰æ›ç‚º JavaScript å°è±¡
                const items = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                shoppingItems = items;
                
                // é‡æ–°æ¸²æŸ“æ¸…å–®
                renderList();
                calculateTotalSpent(items);

                if (items.length === 0) {
                    emptyMessage.classList.remove('hidden');
                } else {
                    emptyMessage.classList.add('hidden');
                }

            }, (error) => {
                console.error("Firestore Listener Error:", error);
                showMessage('è³‡æ–™åº«éŒ¯èª¤', `ç„¡æ³•ç›£è½æ¸…å–®è³‡æ–™: ${error.message}`, true);
            });
        }

        /** æ–°å¢é …ç›® */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) {
                showMessage('éŒ¯èª¤', 'è«‹å…ˆå®Œæˆä½¿ç”¨è€…èªè­‰ã€‚', true);
                return;
            }

            const name = document.getElementById('item-name').value.trim();
            const jpyPrice = parseInt(document.getElementById('item-jpy').value, 10);
            const dayPlanned = document.getElementById('item-day').value.trim();
            const quantity = parseInt(document.getElementById('item-quantity').value, 10) || 1;
            // æ–°å¢ï¼šåœ–ç‰‡ç¶²å€
            const imageUrl = document.getElementById('item-image-url').value.trim();


            if (!name || jpyPrice <= 0) {
                showMessage('éŒ¯èª¤', 'åç¨±å’Œæ­£æ•¸åƒ¹æ ¼ç‚ºå¿…å¡«é …ç›®ã€‚', true);
                return;
            }

            try {
                const newItem = {
                    name,
                    jpyPrice,
                    quantity,
                    dayPlanned: dayPlanned || 'æœªæ’å®š',
                    isBought: false,
                    createdAt: Date.now(),
                    imageUrl: imageUrl // å„²å­˜åœ–ç‰‡ç¶²å€
                };

                const listCollectionRef = collection(db, getCollectionPath());
                await addDoc(listCollectionRef, newItem);
                
                form.reset();
                document.getElementById('item-day').value = 'Day 1'; // Reset default day
                document.getElementById('item-quantity').value = '1'; // Reset default quantity
                
                showMessage('æˆåŠŸ', 'é …ç›®å·²æ–°å¢åˆ°æ‚¨çš„æ¸…å–®ï¼', false);
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('æ–°å¢å¤±æ•—', `ç„¡æ³•æ–°å¢é …ç›®: ${error.message}`, true);
            }
        });

        /** æ›´æ–°é …ç›® (æ¨™è¨˜è³¼è²·ç‹€æ…‹) */
        async function toggleBought(id, isBought) {
            if (!userId) return;
            try {
                const itemRef = doc(db, getCollectionPath(), id);
                await updateDoc(itemRef, {
                    isBought: !isBought
                });
            } catch (error) {
                console.error("Error updating document: ", error);
                showMessage('æ›´æ–°å¤±æ•—', `ç„¡æ³•æ›´æ–°è³¼è²·ç‹€æ…‹: ${error.message}`, true);
            }
        }

        /** åˆªé™¤é …ç›® */
        async function deleteItem(id) {
            if (!userId) return;
            try {
                const itemRef = doc(db, getCollectionPath(), id);
                await deleteDoc(itemRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                showMessage('åˆªé™¤å¤±æ•—', `ç„¡æ³•åˆªé™¤é …ç›®: ${error.message}`, true);
            }
        }

        // --- æ¸²æŸ“èˆ‡ç¸½è¦½è¨ˆç®— ---

        /** è¨ˆç®—å·²è³¼è²·ç¸½èŠ±è²» */
        function calculateTotalSpent(items) {
            let total = 0;
            items.forEach(item => {
                if (item.isBought) {
                    total += item.jpyPrice * item.quantity * exchangeRate;
                }
            });
            totalSpentElement.textContent = `TWD ${total.toFixed(2).toLocaleString('en-US')}`;
        }

        /** æ¸²æŸ“å–®ä¸€é …ç›® */
        function renderItem(item) {
            const twdPrice = calculateTWD(item.jpyPrice, item.quantity);
            const statusClass = item.isBought ? 'bg-green-100 border-green-400' : 'bg-white border-gray-200';
            const textClass = item.isBought ? 'text-gray-500 line-through' : 'text-gray-800';
            
            // è™•ç†åœ–ç‰‡é¡¯ç¤º
            const imageContent = item.imageUrl ? 
                `<img src="${item.imageUrl}" 
                      alt="${item.name}" 
                      class="w-12 h-12 object-cover rounded-md mr-4 flex-shrink-0 border border-gray-300 shadow-sm"
                      onerror="this.onerror=null; this.src='https://placehold.co/48x48/CCCCCC/FFFFFF?text=No+Pic';">`
                : `<div class="w-12 h-12 rounded-md bg-gray-200 text-gray-500 flex items-center justify-center text-xl mr-4 flex-shrink-0" title="ç„¡åœ–ç‰‡">ğŸ›’</div>`; // ä½¿ç”¨è³¼ç‰©è»Š Emoji ä½œç‚ºé è¨­åœ–æ¨™

            
            const itemElement = document.createElement('div');
            itemElement.className = `flex items-center justify-between p-4 rounded-lg shadow-md transition duration-150 ease-in-out ${statusClass}`;
            
            itemElement.innerHTML = `
                <!-- Checkbox & Item Info -->
                <div class="flex items-center min-w-0 flex-grow mr-4">
                    <input type="checkbox" id="check-${item.id}" ${item.isBought ? 'checked' : ''}
                        class="form-checkbox h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 mr-4 flex-shrink-0"
                        onclick="window.toggleBought('${item.id}', ${item.isBought})">
                    
                    ${imageContent} <!-- æ’å…¥åœ–ç‰‡æˆ–é è¨­åœ–æ¨™ -->

                    <div class="min-w-0">
                        <p class="text-lg font-bold truncate ${textClass}" title="${item.name}">${item.name}</p>
                        <p class="text-xs font-semibold text-blue-600 mt-1">${item.dayPlanned}</p>
                    </div>
                </div>

                <!-- Price & Actions -->
                <div class="flex items-center space-x-4 flex-shrink-0">
                    <div class="text-right">
                        <p class="text-sm font-medium ${textClass}">
                            ${item.quantity} x JPY ${item.jpyPrice.toLocaleString('en-US')}
                        </p>
                        <p class="text-base font-bold text-red-600">
                            TWD ${twdPrice.toLocaleString('en-US')}
                        </p>
                    </div>
                    
                    <button class="text-gray-400 hover:text-red-500 transition duration-150 ease-in-out" 
                        title="åˆªé™¤"
                        onclick="window.deleteItem('${item.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            return itemElement;
        }
        
        /** æ¸²æŸ“æ¸…å–® (åŒ…å«ç¯©é¸å’Œåˆ†çµ„) */
        function renderList() {
            listContainer.innerHTML = '';
            
            // æ ¹æ“š currentFilter ç¯©é¸é …ç›®
            let filteredItems = shoppingItems;
            if (currentFilter === 'unbought') {
                filteredItems = shoppingItems.filter(item => !item.isBought);
            } else if (currentFilter === 'bought') {
                filteredItems = shoppingItems.filter(item => item.isBought);
            }
            
            if (filteredItems.length === 0) {
                 emptyMessage.classList.remove('hidden');
                 return;
            } else {
                 emptyMessage.classList.add('hidden');
            }
            
            // ä¾æ“š 'Day' åˆ†çµ„ä¸¦æ’åº
            const groupedByDay = filteredItems.reduce((acc, item) => {
                const day = item.dayPlanned || 'æœªæ’å®š';
                if (!acc[day]) {
                    acc[day] = [];
                }
                acc[day].push(item);
                return acc;
            }, {});

            // å–å¾—æ‰€æœ‰åˆ†çµ„çš„ Key (Day 1, Day 2, Day N...)
            const dayKeys = Object.keys(groupedByDay).sort((a, b) => {
                // å˜—è©¦å°‡ 'Day N' è½‰æ›ç‚ºæ•¸å­—é€²è¡Œæ’åº
                const numA = parseInt(a.replace('Day', '').trim()) || Infinity;
                const numB = parseInt(b.replace('Day', '').trim()) || Infinity;
                if (numA !== Infinity && numB !== Infinity) {
                    return numA - numB;
                }
                return a.localeCompare(b); // å…¶ä»–åç¨±å‰‡ä¾å­—æ¯é †åº
            });
            
            // æ¸²æŸ“åˆ†çµ„å¾Œçš„æ¸…å–®
            dayKeys.forEach(day => {
                const dayGroup = document.createElement('div');
                dayGroup.className = 'mb-6 p-4 bg-gray-100 rounded-lg shadow-inner';
                
                const dayHeader = document.createElement('h3');
                dayHeader.className = 'text-xl font-bold text-gray-700 mb-4 border-b pb-2';
                dayHeader.textContent = `è¡Œç¨‹æ—¥: ${day}`;
                dayGroup.appendChild(dayHeader);
                
                const dayList = document.createElement('div');
                dayList.className = 'space-y-3';
                
                // æ¸²æŸ“è©²çµ„å…§çš„é …ç›®ï¼Œæœªè³¼è²·çš„æ’åœ¨å‰é¢
                groupedByDay[day].sort((a, b) => a.isBought - b.isBought).forEach(item => {
                    dayList.appendChild(renderItem(item));
                });
                
                dayGroup.appendChild(dayList);
                listContainer.appendChild(dayGroup);
            });
        }
        
        /** è¨­å®šç¯©é¸å™¨ */
        function setFilter(filter) {
            currentFilter = filter;
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            Object.keys(filterButtons).forEach(key => {
                if (key === filter) {
                    filterButtons[key].classList.replace('bg-gray-200', 'bg-blue-500');
                    filterButtons[key].classList.replace('text-gray-700', 'text-white');
                    filterButtons[key].classList.add('shadow');
                } else {
                    filterButtons[key].classList.replace('bg-blue-500', 'bg-gray-200');
                    filterButtons[key].classList.replace('text-white', 'text-gray-700');
                    filterButtons[key].classList.remove('shadow');
                }
            });
            renderList();
        }

        // --- äº‹ä»¶ç›£è½å™¨ç¶å®š (éœ€æ›è¼‰åˆ° window ä»¥ä¾¿ HTML å…ƒç´ å‘¼å«) ---
        window.toggleBought = toggleBought;
        window.deleteItem = deleteItem;
        
        filterButtons['all'].addEventListener('click', () => setFilter('all'));
        filterButtons['unbought'].addEventListener('click', () => setFilter('unbought'));
        filterButtons['bought'].addEventListener('click', () => setFilter('bought'));
        
        // --- å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ---
        
        // 1. è¼‰å…¥æœ¬åœ°åŒ¯ç‡è¨­å®š
        loadExchangeRate();
        
        // 2. åˆå§‹åŒ– Firebase & èªè­‰
        if (Object.keys(firebaseConfig).length > 0) {
            initializeFirebase();
        } else {
            console.error("Firebase config is missing.");
            loadingMessage.textContent = 'ç„¡æ³•åˆå§‹åŒ– Firebaseï¼Œè«‹ç¢ºèªè¨­å®šã€‚';
            showMessage('è¨­å®šéŒ¯èª¤', 'ç¼ºå°‘ Firebase è¨­å®šè³‡è¨Šã€‚', true);
        }

    </script>
</body>
</html>